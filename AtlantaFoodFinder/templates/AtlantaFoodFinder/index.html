<!DOCTYPE html>
<html>
<head>
  <title>GMap</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <style>
    /* Reset and map container styling */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    /* Search input styling */
    #search-input {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 5;
      background-color: #fff;
      font-size: 15px;
      padding: 5px;
      border: 1px solid #d0d0d0;
      width: 300px;
    }
    /* Filters styling */
    #filters {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 5;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 10px;
      box-sizing: border-box;
      width: 300px;
    }
    #filters label {
      display: block;
      margin-bottom: 5px;
    }
    /* Place details styling */
    #place-details {
      position: absolute;
      bottom: -300px; /* Start hidden below the viewport */
      left: 0;
      width: 100%;
      max-height: 400px;
      overflow-y: auto;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 10px;
      box-sizing: border-box;
      font-size: 14px;
      z-index: 5;
      transition: bottom 0.5s; /* For slide-up animation */
    }
    /* Show the place details when active */
    #place-details.active {
      bottom: 0; /* Slide up to visible area */
    }
    /* Close button styling */
    #close-details {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #666;
    }
    #close-details:hover {
      color: #000;
    }
    #favorites-panel {
      position: absolute;
      top: 150px; 
      right: 10px;
      z-index: 5;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 10px;
      box-sizing: border-box;
      max-height: 400px;
      overflow-y: auto;
      width: 300px; /* Match the width of the search input */
    }
    #favorites-panel h3 {
      margin-top: 0;
    }
    .favorite-item {
      margin-bottom: 10px;
    }
    button {
      background-color: #4285F4; 
      color: white;
      border: none;
      padding: 6px 12px;
      margin: 5px 0;
      font-size: 14px;
      cursor: pointer;
      border-radius: 3px;
    }
    button:hover {
      background-color: #357AE8;
    }
    .btn-view {
      background-color: #34A853; 
    }
    .btn-view:hover {
      background-color: #2C8C47;
    }
    .btn-remove {
      background-color: #EA4335;
    }
    .btn-remove:hover {
      background-color: #C62828;
    }
    #add-to-favorites {
      margin-left: 10px;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFlzEUvEDRjPBCNgR-gucZ82Muk49PQu4&libraries=places"></script>
</head>
<body>
  <input id="search-input" type="text" placeholder="Search Box">
  <div id="filters">
    <label>Radius (km): <input id="radius-input" type="number" value="5" min="1" max="50000"></label>
    <label>Minimum Rating: <input id="rating-input" type="number" step="0.1" min="0" max="5"></label>
  </div>
  <div id="favorites-panel">
    <h3>Favorites</h3>
    <div id="favorites-list"></div>
  </div>
  <div id="map"></div>
  <div id="place-details">
    <button id="close-details">X</button>
    <div id="place-content"></div>
  </div>

  <script>
    function initMap() {
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12
      });

      var input = document.getElementById('search-input');
      var radiusInput = document.getElementById('radius-input');
      var ratingInput = document.getElementById('rating-input');
      var autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo('bounds', map);

      var marker = new google.maps.Marker({
        map: map
      });

      var service = new google.maps.places.PlacesService(map);

      var favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      updateFavoritesList();

      var searchMarkers = [];

      // Handle Enter key press on the search input
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          performSearch(input.value);
        }
      });

      // Autocomplete place changed event
      autocomplete.addListener('place_changed', function() {
        marker.setVisible(false);
        var place = autocomplete.getPlace();
        if (!place.geometry) {
          performSearch(place.name || input.value);
          return;
        }

        if (place.geometry.viewport) {
          map.fitBounds(place.geometry.viewport);
        } else {
          map.setCenter(place.geometry.location);
          map.setZoom(17);  
        }

        marker.setPosition(place.geometry.location);
        marker.setVisible(true);

        var request = {
          placeId: place.place_id,
          fields: ['place_id', 'name', 'rating', 'formatted_address', 'geometry', 'reviews', 'photos', 'opening_hours', 'formatted_phone_number', 'website', 'types']
        };

        service.getDetails(request, function(placeResult, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            showPlaceDetails(placeResult);
          } else {
            console.error('Error fetching place details:', status);
          }
        });
      });

      function performSearch(query) {
        var radiusValue = 1000 * parseInt(radiusInput.value) || 5;
        var minRating = parseFloat(ratingInput.value) || 0;

        var request = {
          query: query,
          location: map.getCenter(),
          radius: radiusValue,
          type: ['restaurant'],
        };
        service.textSearch(request, function(results, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            // Filter results by rating
            results = results.filter(function(place) {
              return (place.rating || 0) >= minRating;
            });
            showSearchResults(results);
          } else {
            console.error('Search failed:', status);
          }
        });
      }

      function showSearchResults(results) {
        // Clear existing markers
        searchMarkers.forEach(function(marker) {
          marker.setMap(null);
        });
        searchMarkers = [];

        var bounds = new google.maps.LatLngBounds();

        results.forEach(function(place) {
          if (!place.geometry || !place.geometry.location) return;

          var searchMarker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            title: place.name,
          });
          searchMarker.placeResult = place; // Save the place result in marker for later use

          searchMarker.addListener('click', function() {
            service.getDetails({
              placeId: this.placeResult.place_id,
              fields: ['place_id', 'name', 'rating', 'formatted_address', 'geometry', 'reviews', 'photos', 'opening_hours', 'formatted_phone_number', 'website', 'types']
            }, function(placeResult, status) {
              if (status === google.maps.places.PlacesServiceStatus.OK) {
                showPlaceDetails(placeResult);
              } else {
                console.error('Error fetching place details:', status);
              }
            });
          });

          searchMarkers.push(searchMarker);

          bounds.extend(place.geometry.location);
        });

        map.fitBounds(bounds);
      }

      function showPlaceDetails(placeResult) {
        var contentString = '<div><strong>' + placeResult.name + '</strong>';

        contentString += ' <button id="add-to-favorites">Add to Favorites</button><br>';

        contentString += 'Rating: ' + (placeResult.rating || 'N/A') + '<br>' +
                         placeResult.formatted_address + '<br>';

        if (placeResult.formatted_phone_number) {
          contentString += 'Phone: ' + placeResult.formatted_phone_number + '<br>';
        }
        if (placeResult.website) {
          contentString += 'Website: <a href="' + placeResult.website + '" target="_blank">' + placeResult.website + '</a><br>';
        }
        console.log(placeResult)
        // Display cuisine type
        var cuisineType = getCuisineType(placeResult.types);
        if (cuisineType) {
          contentString += 'Cuisine: ' + cuisineType.charAt(0).toUpperCase() + cuisineType.slice(1) + '<br>';
        }

        if (placeResult.opening_hours && placeResult.opening_hours.weekday_text) {
          contentString += '<br><strong>Opening Hours:</strong><br>';
          placeResult.opening_hours.weekday_text.forEach(function(day) {
            contentString += day + '<br>';
          });
        }

        if (placeResult.reviews && placeResult.reviews.length > 0) {
          contentString += '<br><strong>Reviews:</strong><br>';
          placeResult.reviews.slice(0, 3).forEach(function(review) {
            contentString += '<p>"' + review.text + '" - ' + review.author_name + '</p>';
          });
        }

        if (placeResult.photos && placeResult.photos.length > 0) {
          var photoUrl = placeResult.photos[0].getUrl({ maxWidth: 300 });
          contentString += '<br><img src="' + photoUrl + '" alt="' + placeResult.name + '">';
        }

        contentString += '</div>';

        var placeContentDiv = document.getElementById('place-content');
        placeContentDiv.innerHTML = contentString;

        var placeDetailsDiv = document.getElementById('place-details');
        placeDetailsDiv.classList.add('active');

        document.getElementById('add-to-favorites').addEventListener('click', function() {
          addToFavorites(placeResult);
        });
      }

      function getCuisineType(types) {
        console.log(types)
        var cuisine = null;
        types.forEach(function(type) {
          if (type.endsWith('_restaurant') && type !== 'restaurant') {
            cuisine = type.replace('_restaurant', '').replace('_', ' ');
          }
        });
        return cuisine;
      }

      function addToFavorites(place) {
        const url = '/AtlantaFoodFinder/api/add_favorite/';        // Your Django API endpoint URL
        const data = {
            place_id: place.place_id,
            name: place.name,
            location: place.geometry.location,
            formatted_address: place.formatted_address
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)     // Sending the data in the request body
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                updateFavoritesList();
            } else if (data.error) {
                alert('Error: ' + data.error);   // Show error message
            }
        })
        .catch(error => console.error('Error:', error));
      }

      function updateFavoritesList() {
        var favoritesListDiv = document.getElementById('favorites-list');
        favoritesListDiv.innerHTML = '';

        // Fetch favorite places from the server
        fetch('/AtlantaFoodFinder/api/get_favorites')  // Adjust the URL to match your Django endpoint
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Use the 'existing_favorites' key returned from Django
                favorites = data.existing_favorites;

                if (favorites.length === 0) {
                    favoritesListDiv.innerHTML = '<p>No favorites yet.</p>';
                    return;
                }

                favorites.forEach(function(fav) {
                    var favDiv = document.createElement('div');
                    favDiv.className = 'favorite-item';
                    favDiv.innerHTML = '<strong>' + fav.name + '</strong><br>' +
                                       fav.formatted_address + '<br>' +
                                       '<button class="btn-view" data-place-id="' + fav.place_id + '">View</button>' +
                                       '<button class="btn-remove" data-place-id="' + fav.place_id + '">Remove</button>';


                    // View button functionality
                    favDiv.querySelector('button[data-place-id]').addEventListener('click', function() {
                        // Center the map and set marker
                        map.setCenter(fav.location);
                        map.setZoom(17);

                        marker.setPosition(fav.location);
                        marker.setVisible(true);

                        var request = {
                            placeId: fav.place_id,
                            fields: ['place_id', 'name', 'rating', 'formatted_address', 'geometry', 'reviews', 'photos', 'opening_hours', 'formatted_phone_number', 'website']
                        };


                        service.getDetails(request, function(placeResult, status) {
                            if (status === google.maps.places.PlacesServiceStatus.OK) {
                                showPlaceDetails(placeResult);
                            } else {
                                console.error('Error fetching place details:', status);
                            }
                        });
                    });

                    // Remove button functionality
                    favDiv.querySelector('button.btn-remove').addEventListener('click', function() {
                        var placeIdToRemove = this.getAttribute('data-place-id'); // Get place_id from button
                        removeFromFavorites(placeIdToRemove); // Call the function with place_id
                    });

                    favoritesListDiv.appendChild(favDiv);
                });
            })
            .catch(error => {
                console.error('Error fetching favorites:', error);
                favoritesListDiv.innerHTML = '<p>Error loading favorites. Please try again later.</p>';
            });
      }
      function removeFromFavorites(placeIdToRemove) {
        const url = '/AtlantaFoodFinder/api/remove_favorite/';        // Your Django API endpoint URL
        const data = {
            place_id: placeIdToRemove,
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)     // Sending the data in the request body
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                updateFavoritesList();
            } else if (data.error) {
                alert('Error: ' + data.error);   // Show error message
            }
        })
        .catch(error => console.error('Error:', error));
      }

      google.maps.event.addListener(map, 'click', function(event) {
        var clickedLocation = event.latLng;

        marker.setPosition(clickedLocation);
        marker.setVisible(true);

        var request = {
          location: clickedLocation,
          rankBy: google.maps.places.RankBy.DISTANCE,
          type: ['establishment'] 
        };

        service.nearbySearch(request, function(results, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
            var placeId = results[0].place_id;

            var detailsRequest = {
              placeId: placeId,
              fields: ['place_id', 'name', 'rating', 'formatted_address', 'geometry', 'reviews', 'photos', 'opening_hours', 'formatted_phone_number', 'website', 'types']
            };

            service.getDetails(detailsRequest, function(placeResult, status) {
              if (status === google.maps.places.PlacesServiceStatus.OK) {
                showPlaceDetails(placeResult);
              } else {
                console.error('Error fetching place details:', status);
                document.getElementById('place-content').innerHTML = 'Error fetching place details.';
              }
            });
          } else {
            console.error('No places found near this location:', status);
            document.getElementById('place-content').innerHTML = 'No place found at this location.';
          }

          document.getElementById('place-details').classList.add('active');
        });
      });

      google.maps.event.addListener(map, 'dragstart', function() {
        document.getElementById('place-details').classList.remove('active');
      });

      document.getElementById('close-details').addEventListener('click', function() {
        document.getElementById('place-details').classList.remove('active');
      });

      // Get user's location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          map.setCenter(userLocation);

          var userMarker = new google.maps.Marker({
            position: userLocation,
            map: map,
            title: 'You are here'
          });
        }, function() {
          handleLocationError(true, map.getCenter());
        });
      } else {
        handleLocationError(false, map.getCenter());
      }

      function handleLocationError(browserHasGeolocation, pos) {
        alert(browserHasGeolocation ?
              'Error: The Geolocation service failed.' :
              'Error: Your browser doesn\'t support geolocation.');
      }
    }

    google.maps.event.addDomListener(window, 'load', initMap);
  </script>
</body>
</html>
